<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LinkedIn Growth Leaderboard</title>
  <meta name="description" content="Track LinkedIn growth across teams with an interactive leaderboard and trend chart." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      /* Company brand colors */
      --primary: #22daae;
      --secondary: #ff4dd8;
      --dark: #09100f;
      --light: #f9f8f5;
      
      /* Derived colors */
      --primary-light: rgba(34, 218, 174, 0.1);
      --primary-soft: rgba(34, 218, 174, 0.8);
      --secondary-light: rgba(255, 77, 216, 0.1);
      --secondary-soft: rgba(255, 77, 216, 0.8);
      
      /* Text colors */
      --text-primary: var(--dark);
      --text-secondary: rgba(9, 16, 15, 0.7);
      --text-muted: rgba(9, 16, 15, 0.5);
      --text-inverse: var(--light);
      
      /* Background and surface colors */
      --bg-primary: var(--light);
      --surface: #ffffff;
      --surface-elevated: #ffffff;
      
      /* Status colors */
      --success: #22daae;
      --warning: #ff4dd8;
      --danger: #ff6b6b;
      
      /* Effects */
      --shadow: 0 10px 30px rgba(9, 16, 15, 0.08);
      --shadow-elevated: 0 20px 40px rgba(9, 16, 15, 0.12);
      --border-radius: 16px;
      --border-radius-small: 8px;
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--text-primary);
      line-height: 1.6;
    }

    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 24px; 
    }

    .header {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text-inverse);
      padding: 32px;
      margin-bottom: 32px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }

    .header h1 { 
      font-size: 32px; 
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--light), rgba(255, 255, 255, 0.8));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header p { 
      opacity: 0.9; 
      font-size: 16px;
      font-weight: 500;
    }

    .last-updated { 
      font-size: 14px; 
      opacity: 0.8; 
      margin-top: 12px; 
      font-weight: 400;
    }

    /* View Toggle */
    .view-toggle {
      display: flex;
      background: var(--surface);
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(9, 16, 15, 0.1);
    }

    .toggle-option {
      flex: 1;
      padding: 12px 24px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }

    .toggle-option.active {
      background: linear-gradient(135deg, var(--primary), var(--primary-soft));
      color: var(--text-inverse);
      box-shadow: 0 4px 12px rgba(34, 218, 174, 0.3);
    }

    .toggle-option:hover:not(.active) {
      background: var(--primary-light);
      color: var(--text-primary);
    }

    /* Controls */
    .controls {
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px; 
      margin-bottom: 24px;
    }

    .control {
      background: var(--surface);
      padding: 20px;
      border-radius: var(--border-radius-small);
      box-shadow: var(--shadow);
      border: 1px solid rgba(9, 16, 15, 0.1);
    }

    .control label { 
      display: block;
      font-weight: 600; 
      margin-bottom: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }

    select, button {
      width: 100%;
      border: 2px solid rgba(9, 16, 15, 0.1);
      border-radius: var(--border-radius-small);
      padding: 12px 16px; 
      font-weight: 500; 
      font-size: 14px;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    select { 
      background: var(--surface); 
      color: var(--text-primary);
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    button { 
      background: linear-gradient(135deg, var(--secondary), var(--secondary-soft));
      color: var(--text-inverse); 
      cursor: pointer;
      border: none;
      font-weight: 600;
    }

    button:hover { 
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(255, 77, 216, 0.3);
    }

    button:disabled { 
      opacity: 0.6; 
      cursor: not-allowed; 
      transform: none; 
    }

    /* Error and loading states */
    .error {
      display: none; 
      background: var(--danger); 
      color: var(--text-inverse);
      padding: 12px 14px; 
      border-radius: 10px; 
      margin-bottom: 16px; 
      text-align: center;
      box-shadow: var(--shadow);
    }

    .loading { 
      color: var(--text-inverse); 
      text-align: center; 
      padding: 40px; 
      font-size: 16px; 
    }

    /* Stats grid */
    .stats {
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px; 
      margin-bottom: 24px;
    }

    .stat {
      background: var(--surface); 
      padding: 24px; 
      border-radius: var(--border-radius-small);
      text-align: center; 
      box-shadow: var(--shadow);
      border: 1px solid rgba(9, 16, 15, 0.1);
    }

    .stat .num { 
      font-size: 28px; 
      font-weight: 800; 
      color: var(--primary);
      margin-bottom: 4px;
    }

    .stat .lbl { 
      color: var(--text-muted); 
      font-size: 13px; 
      font-weight: 500;
    }

    /* Monthly Winner Styles */
    .monthly-winner {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--text-inverse);
      padding: 24px;
      border-radius: var(--border-radius);
      margin-bottom: 24px;
      box-shadow: var(--shadow-elevated);
    }

    .monthly-winner h3 {
      margin-bottom: 16px;
      font-size: 18px;
      font-weight: 600;
    }

    .winner-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .winner-details {
      flex: 1;
    }

    .winner-name {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .winner-name a {
      color: inherit;
      text-decoration: none;
    }

    .winner-name a:hover {
      text-decoration: underline;
    }

    .winner-growth {
      font-size: 24px;
      font-weight: 900;
      color: var(--light);
    }

    .period-selector {
      margin-bottom: 16px;
    }

    .period-selector label {
      margin-right: 8px;
      font-weight: 600;
    }

    .period-selector select {
      background: rgba(255, 255, 255, 0.9);
      color: var(--dark);
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      min-width: 200px;
    }

    /* Panel styles */
    .panel {
      background: var(--surface); 
      border-radius: var(--border-radius); 
      padding: 24px; 
      box-shadow: var(--shadow-elevated);
      margin-bottom: 24px;
      border: 1px solid rgba(9, 16, 15, 0.1);
    }

    .panel h2 { 
      font-size: 20px; 
      margin-bottom: 20px; 
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Leaderboard table styles */
    .leaderboard-header, .row {
      display: grid; 
      align-items: center; 
      gap: 16px;
      padding: 16px 20px;
    }

    .employee-view .leaderboard-header, .employee-view .row {
      grid-template-columns: 56px 1fr 120px 120px 120px;
    }

    .business-line-view .leaderboard-header, .business-line-view .row {
      grid-template-columns: 56px 1fr 100px 120px 120px 120px;
    }

    .leaderboard-header {
      color: var(--text-muted); 
      font-weight: 700; 
      border-bottom: 2px solid var(--primary-light);
      margin-bottom: 8px;
      background: var(--primary-light);
      border-radius: var(--border-radius-small);
    }

    .row {
      border-radius: var(--border-radius-small); 
      transition: all 0.2s ease;
      border-left: 4px solid transparent; 
      margin-bottom: 8px;
      border: 1px solid transparent;
    }

    .row:hover { 
      background: var(--primary-light); 
      transform: translateX(4px); 
      box-shadow: 0 4px 16px rgba(34, 218, 174, 0.15);
      border-color: var(--primary);
    }

    .row.rank-1 { 
      background: linear-gradient(45deg, var(--primary), rgba(34, 218, 174, 0.1)); 
      border-left-color: var(--primary); 
    }

    .row.rank-2 { 
      background: linear-gradient(45deg, var(--secondary), rgba(255, 77, 216, 0.1)); 
      border-left-color: var(--secondary); 
    }

    .row.rank-3 { 
      background: linear-gradient(45deg, var(--dark), rgba(9, 16, 15, 0.1)); 
      border-left-color: var(--dark); 
    }

    .rank {
      width: 40px; 
      height: 40px; 
      border-radius: 50%; 
      background: var(--surface-accent);
      color: var(--text-secondary); 
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-weight: 800; 
      font-size: 18px;
      border: var(--border);
    }

    .row.rank-1 .rank { 
      color: var(--text-inverse); 
      background: var(--primary);
      border-color: var(--primary);
    }

    .row.rank-2 .rank { 
      color: var(--text-inverse); 
      background: var(--secondary);
      border-color: var(--secondary);
    }

    .row.rank-3 .rank { 
      color: var(--text-inverse); 
      background: var(--tertiary);
      border-color: var(--tertiary);
    }

    .name a, .name div { 
      font-weight: 700; 
      color: var(--text-primary); 
      text-decoration: none; 
    }

    .name a:hover { 
      color: var(--primary); 
      text-decoration: underline; 
    }

    .subtle { 
      color: var(--text-muted); 
      font-size: 13px; 
      margin-top: 2px; 
      font-weight: 500;
    }

    .metric { 
      text-align: center; 
      font-weight: 800; 
    }

    .pos { color: #22daae !important; }
    .neg { color: #ff4dd8 !important; }
    .neu { color: rgba(0, 0, 0, 0.5) !important; }

    .no-data { 
      color: rgba(0, 0, 0, 0.5) !important; 
      font-style: italic; 
      text-align: center; 
      padding: 40px; 
      font-size: 16px;
    }

    /* Badge styles for business lines */
    .business-line-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(34, 218, 174, 0.1) !important;
      color: #000000 !important;
      border: 1px solid rgba(34, 218, 174, 0.2) !important;
    } 500;
    }

    .metric { 
      text-align: center; 
      font-weight: 800; 
    }

    .pos { color: var(--success); }
    .neg { color: var(--danger); }
    .neu { color: var(--text-muted); }

    .no-data { 
      color: var(--text-muted); 
      font-style: italic; 
      text-align: center; 
      padding: 40px; 
      font-size: 16px;
    }

    /* Badge styles for business lines */
    .business-line-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: var(--primary-light);
      color: var(--text-primary);
      border: 1px solid rgba(34, 218, 174, 0.2);
    }

    /* Chart styles */
    .chart-section {
      padding: 24px;
      border-top: 1px solid rgba(9, 16, 15, 0.1);
      background: var(--primary-light);
      border-radius: 0 0 var(--border-radius) var(--border-radius);
    }

    .chart-container {
      position: relative;
      height: 400px;
      background: var(--surface);
      border-radius: var(--border-radius-small);
      padding: 20px;
      box-shadow: var(--shadow);
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }
      
      .header {
        padding: 24px 20px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .controls {
        grid-template-columns: 1fr;
      }
      
      .view-toggle {
        flex-direction: column;
      }
      
      .leaderboard-header, .row { 
        grid-template-columns: 50px 1fr 110px; 
      }
      
      .leaderboard-header > :nth-child(n+4), .row > :nth-child(n+4) { 
        display: none; 
      }
      
      .winner-info { 
        flex-direction: column; 
        text-align: center; 
      }
      
      .period-selector { 
        text-align: center; 
      }
      
      .period-selector select { 
        min-width: auto; 
        width: 100%; 
      }
    }

    /* Animation for view transitions */
    .fade-transition {
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .fade-transition.visible {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>LinkedIn Growth Leaderboard</h1>
      <p>Track individual and business line LinkedIn network growth performance</p>
      <div class="last-updated" id="lastUpdated"></div>
    </header>

    <div id="error" class="error"></div>

    <!-- View Toggle -->
    <div class="view-toggle">
      <button class="toggle-option active" id="employeeView" onclick="switchView('employee')">
        Individual Employees
      </button>
      <button class="toggle-option" id="businessLineView" onclick="switchView('businessLine')">
        Business Lines
      </button>
    </div>

    <section class="controls">
      <div class="control">
        <label for="metric">Sort by</label>
        <select id="metric">
          <option value="monthlyGrowth">Monthly Growth (Followers)</option>
          <option value="monthlyGrowthRate">Monthly Growth %</option>
          <option value="currentFollowers">Follower Count</option>
          <option value="overallGrowthRate">Overall Growth %</option>
        </select>
      </div>
      <div class="control">
        <label for="team">Business Line</label>
        <select id="team">
          <option value="all">All Teams</option>
        </select>
      </div>
      <div class="control">
        <label>&nbsp;</label>
        <button id="refresh">Refresh Data</button>
      </div>
    </section>

    <div id="loading" class="loading">Loading leaderboard data…</div>

    <main id="main" style="display:none">
      <section class="stats">
        <article class="stat">
          <div class="num" id="statTotal">-</div>
          <div class="lbl" id="statTotalLabel">Active Employees</div>
        </article>
        <article class="stat">
          <div class="num" id="statAvgGrowth">-</div>
          <div class="lbl">Avg Growth Rate</div>
        </article>
        <article class="stat">
          <div class="num" id="statTopGrower">-</div>
          <div class="lbl" id="statTopGrowerLabel">Top Grower</div>
        </article>
        <article class="stat">
          <div class="num" id="statTotalFollowers">-</div>
          <div class="lbl">Total Network</div>
        </article>
      </section>

      <section class="monthly-winner" id="monthlyWinnerSection" style="display:none">
        <div class="period-selector">
          <label for="periodSelect">Monthly Winners:</label>
          <select id="periodSelect">
            <option value="">Select a month...</option>
          </select>
        </div>
        <div id="monthlyWinnerContent">
          <h3 id="winnerTitle">Monthly Champion</h3>
          <div class="winner-info">
            <div class="winner-details">
              <div class="winner-name" id="winnerName">—</div>
              <div class="subtle" id="winnerTeam">—</div>
            </div>
            <div class="winner-growth" id="winnerGrowth">—</div>
          </div>
        </div>
      </section>

      <section class="panel">
        <div id="leaderboardContainer" class="employee-view">
          <div class="leaderboard-header">
            <div>Rank</div>
            <div>Employee</div>
            <div id="metricHeader">Monthly Growth</div>
            <div>Follower Count</div>
            <div>Absolute Growth</div>
          </div>
          <div id="board"></div>
        </div>
      </section>

      <section class="panel">
        <div class="chart-section">
          <h2 id="chartTitle">Top 10 Growth Trends</h2>
          <div class="chart-container">
            <canvas id="chart" width="400" height="220" aria-label="Growth trend lines" role="img"></canvas>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = '/api';
    let EMPLOYEES = [];
    let BUSINESS_LINES = [];
    let MONTHLY_WINNERS = [];
    let SUMMARY = {};
    let chart;
    let currentView = 'employee';

    // ---------- Utilities ----------
    const fmtPct = (n) => `${Number(n || 0).toFixed(1)}%`;
    const fmtInt = (n) => Number(n || 0).toLocaleString();
    const safeStr = (s) => (s == null ? '' : String(s));

    function setLoading(on) {
      const loading = document.getElementById('loading');
      const main = document.getElementById('main');
      const refresh = document.getElementById('refresh');
      
      if (loading) loading.style.display = on ? 'block' : 'none';
      if (main) main.style.display = on ? 'none' : 'block';
      if (refresh) refresh.disabled = on;
    }

    function showError(msg) {
      const box = document.getElementById('error');
      if (box) {
        box.textContent = msg;
        box.style.display = 'block';
      }
    }

    function hideError() {
      const box = document.getElementById('error');
      if (box) box.style.display = 'none';
    }

    function switchView(view) {
      currentView = view;
      
      // Update toggle buttons
      document.getElementById('employeeView').classList.toggle('active', view === 'employee');
      document.getElementById('businessLineView').classList.toggle('active', view === 'businessLine');
      
      // Update container class
      const container = document.getElementById('leaderboardContainer');
      if (container) {
        container.className = view === 'employee' ? 'employee-view' : 'business-line-view';
      }
      
      // Add fade transition
      const main = document.getElementById('main');
      if (main) {
        main.classList.add('fade-transition');
        
        setTimeout(() => {
          renderAll();
          main.classList.add('visible');
        }, 150);
      }
    }

    // ---------- Data fetch + normalization ----------
    async function fetchData() {
      setLoading(true);
      hideError();
      try {
        const res = await fetch(`${API_BASE}/employees`, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error(`HTTP ${res.status} – ${res.statusText}`);
        const data = await res.json();

        EMPLOYEES = Array.isArray(data.employees) ? data.employees : [];
        BUSINESS_LINES = Array.isArray(data.businessLines) ? data.businessLines : [];
        MONTHLY_WINNERS = Array.isArray(data.monthlyWinners) ? data.monthlyWinners : [];
        SUMMARY = data.summary || {};

        console.log('Loaded employees:', EMPLOYEES.length);
        console.log('Loaded business lines:', BUSINESS_LINES.length);
        console.log('Sample employee:', EMPLOYEES[0]);
        console.log('Sample business line:', BUSINESS_LINES[0]);

        renderAll();
      } catch (err) {
        console.error('Fetch error:', err);
        showError(`Failed to load data: ${err.message}`);
      } finally {
        setLoading(false);
      }
    }

    // ---------- Rendering ----------
    function renderAll() {
      populateTeamFilter();
      populatePeriodSelector();
      renderStats();
      renderBoard();
      renderChart();
      renderLastUpdated();
    }

    function renderLastUpdated() {
      const el = document.getElementById('lastUpdated');
      if (el) {
        const ts = SUMMARY.lastUpdated ? new Date(SUMMARY.lastUpdated) : null;
        el.textContent = ts ? `Last updated: ${ts.toLocaleString()}` : '';
      }
    }

    function renderStats() {
      const statTotal = document.getElementById('statTotal');
      const statTotalLabel = document.getElementById('statTotalLabel');
      const statAvgGrowth = document.getElementById('statAvgGrowth');
      const statTopGrower = document.getElementById('statTopGrower');
      const statTopGrowerLabel = document.getElementById('statTopGrowerLabel');
      const statTotalFollowers = document.getElementById('statTotalFollowers');

      if (currentView === 'employee') {
        if (statTotal) statTotal.textContent = fmtInt(SUMMARY.totalEmployees || EMPLOYEES.length || 0);
        if (statTotalLabel) statTotalLabel.textContent = 'Active Employees';
        if (statAvgGrowth) statAvgGrowth.textContent = fmtPct(SUMMARY.avgGrowthRate || 0);
        if (statTopGrower) statTopGrower.textContent = safeStr(SUMMARY.topGrower || '—');
        if (statTopGrowerLabel) statTopGrowerLabel.textContent = 'Top Grower';
        if (statTotalFollowers) statTotalFollowers.textContent = fmtInt(SUMMARY.totalFollowers || 0);
      } else {
        if (statTotal) statTotal.textContent = fmtInt(BUSINESS_LINES.length || 0);
        if (statTotalLabel) statTotalLabel.textContent = 'Business Lines';
        if (statAvgGrowth) {
          const avgBizGrowth = BUSINESS_LINES.length > 0 ? 
            BUSINESS_LINES.reduce((acc, bl) => acc + (bl.metrics?.growthRate || 0), 0) / BUSINESS_LINES.length : 0;
          statAvgGrowth.textContent = fmtPct(avgBizGrowth);
        }
        if (statTopGrower) {
          const topBizLine = BUSINESS_LINES.reduce((best, bl) => 
            (bl.metrics?.growthRate || 0) > (best?.metrics?.growthRate || -Infinity) ? bl : best, null);
          statTopGrower.textContent = topBizLine ? topBizLine.name : '—';
        }
        if (statTopGrowerLabel) statTopGrowerLabel.textContent = 'Top Business Line';
        if (statTotalFollowers) {
          const totalBizFollowers = BUSINESS_LINES.reduce((acc, bl) => acc + (bl.metrics?.currentFollowers || 0), 0);
          statTotalFollowers.textContent = fmtInt(totalBizFollowers);
        }
      }
    }

    function populateTeamFilter() {
      const sel = document.getElementById('team');
      if (!sel) return;
      
      while (sel.children.length > 1) sel.removeChild(sel.lastChild);

      if (currentView === 'employee') {
        const lines = [...new Set(EMPLOYEES.map(e => e.businessLine).filter(Boolean))].sort();
        lines.forEach(line => {
          const opt = document.createElement('option');
          opt.value = line.toLowerCase();
          opt.textContent = line;
          sel.appendChild(opt);
        });
      } else {
        // For business line view, we might want different filtering options
        // For now, we'll keep it simple and hide the filter or make it less relevant
        sel.style.display = 'none';
      }
    }

    function populatePeriodSelector() {
      const select = document.getElementById('periodSelect');
      if (!select) return;
      
      select.innerHTML = '<option value="">Select a month...</option>';
      
      // Use appropriate winners based on current view
      const winners = currentView === 'employee' ? MONTHLY_WINNERS : 
        (MONTHLY_WINNERS.businessLines || []);
      
      winners.forEach((winner, index) => {
        const option = document.createElement('option');
        option.value = winner.monthKey;
        option.textContent = winner.month;
        if (index === 0) option.selected = true;
        select.appendChild(option);
      });
      
      const section = document.getElementById('monthlyWinnerSection');
      if (section) {
        section.style.display = winners.length > 0 ? 'block' : 'none';
      }
      
      if (winners.length > 0) {
        showMonthlyWinner(winners[0]);
      }
    }

    function showMonthlyWinner(winnerData) {
      const nameEl = document.getElementById('winnerName');
      const teamEl = document.getElementById('winnerTeam');
      const growthEl = document.getElementById('winnerGrowth');
      const titleEl = document.getElementById('winnerTitle');
      
      if (titleEl) {
        titleEl.textContent = currentView === 'employee' ? 'Monthly Champion' : 'Top Business Line';
      }
      
      if (nameEl) {
        if (currentView === 'employee' && winnerData.winner.linkedinProfile) {
          nameEl.innerHTML = `<a href="${winnerData.winner.linkedinProfile}" target="_blank" rel="noopener noreferrer">${winnerData.winner.name}</a>`;
        } else {
          nameEl.textContent = winnerData.winner.name;
        }
      }
      
      if (teamEl) {
        teamEl.textContent = currentView === 'employee' ? 
          (winnerData.winner.businessLine || 'Unassigned') :
          `${fmtPct(winnerData.winner.monthlyGrowthRate)} growth`;
      }
      
      if (growthEl) {
        growthEl.textContent = currentView === 'employee' ? 
          `+${fmtInt(winnerData.winner.monthlyGrowth)}` :
          `+${fmtInt(winnerData.winner.monthlyGrowth)}`;
      }
    }

    function getFilteredEmployees() {
      const teamVal = document.getElementById('team')?.value || 'all';
      const list = (teamVal === 'all')
        ? EMPLOYEES
        : EMPLOYEES.filter(e => (e.businessLine || '').toLowerCase().includes(teamVal));
      return [...list];
    }

    function getLatestMonthlyMetric(employee) {
      if (!employee.monthlyMetrics || employee.monthlyMetrics.length === 0) {
        return {
          currentFollowers: employee.metrics?.currentFollowers || 0,
          monthlyGrowth: 0,
          monthlyGrowthRate: 0
        };
      }
      const latest = employee.monthlyMetrics[employee.monthlyMetrics.length - 1];
      return {
        currentFollowers: latest.currentFollowers || 0,
        monthlyGrowth: latest.monthlyGrowth || 0,
        monthlyGrowthRate: latest.monthlyGrowthRate || 0
      };
    }

    function renderBoard() {
      const metric = document.getElementById('metric')?.value || 'monthlyGrowth';
      const board = document.getElementById('board');
      const metricHeader = document.getElementById('metricHeader');
      
      if (!board) return;

      // Update header based on view and metric
      const headerMap = {
        monthlyGrowth: 'Monthly Growth',
        monthlyGrowthRate: 'Growth %',
        currentFollowers: 'Followers',
        overallGrowthRate: 'Overall Growth %'
      };
      
      if (metricHeader) metricHeader.textContent = headerMap[metric];

      if (currentView === 'employee') {
        renderEmployeeBoard(metric, board);
      } else {
        renderBusinessLineBoard(metric, board);
      }
    }

    function renderEmployeeBoard(metric, board) {
      // Update headers for employee view
      const container = document.getElementById('leaderboardContainer');
      if (container) {
        container.querySelector('.leaderboard-header').innerHTML = `
          <div>Rank</div>
          <div>Employee</div>
          <div id="metricHeader">${document.getElementById('metricHeader').textContent}</div>
          <div>Follower Count</div>
          <div>Absolute Growth</div>
        `;
      }

      let rows = getFilteredEmployees();
      
      // Sort based on selected metric
      if (metric === 'monthlyGrowth') {
        rows = rows.sort((a, b) => {
          const aMetric = getLatestMonthlyMetric(a);
          const bMetric = getLatestMonthlyMetric(b);
          return bMetric.monthlyGrowth - aMetric.monthlyGrowth;
        });
      } else if (metric === 'monthlyGrowthRate') {
        rows = rows.sort((a, b) => {
          const aMetric = getLatestMonthlyMetric(a);
          const bMetric = getLatestMonthlyMetric(b);
          return bMetric.monthlyGrowthRate - aMetric.monthlyGrowthRate;
        });
      } else if (metric === 'currentFollowers') {
        rows = rows.sort((a, b) => {
          const aMetric = getLatestMonthlyMetric(a);
          const bMetric = getLatestMonthlyMetric(b);
          return bMetric.currentFollowers - aMetric.currentFollowers;
        });
      } else if (metric === 'overallGrowthRate') {
        rows = rows.sort((a, b) => (b.metrics?.growthRate ?? 0) - (a.metrics?.growthRate ?? 0));
      }

      if (!rows.length) {
        board.innerHTML = '<div class="no-data">No employee data available for selected filters.</div>';
        return;
      }

      const html = rows.map((e, i) => {
        const rankClass = i < 3 ? ` rank-${i + 1}` : '';
        const monthlyMetric = getLatestMonthlyMetric(e);
        
        let val, display;
        if (metric === 'monthlyGrowth') {
          val = monthlyMetric.monthlyGrowth;
          display = fmtInt(val);
        } else if (metric === 'monthlyGrowthRate') {
          val = monthlyMetric.monthlyGrowthRate;
          display = fmtPct(val);
        } else if (metric === 'currentFollowers') {
          val = monthlyMetric.currentFollowers;
          display = fmtInt(val);
        } else if (metric === 'overallGrowthRate') {
          val = e.metrics?.growthRate ?? 0;
          display = fmtPct(val);
        }
        
        const valCls = val > 0 ? 'pos' : (val < 0 ? 'neg' : 'neu');
        
        const followerCount = fmtInt(monthlyMetric.currentFollowers);
        const absoluteGrowth = monthlyMetric.monthlyGrowth;
        const absoluteGrowthCls = absoluteGrowth >= 0 ? 'pos' : 'neg';
        const absoluteGrowthStr = absoluteGrowth >= 0 ? `+${fmtInt(absoluteGrowth)}` : fmtInt(absoluteGrowth);

        const nameHtml = e.linkedinProfile
          ? `<a href="${e.linkedinProfile}" target="_blank" rel="noopener noreferrer">${safeStr(e.firstName)} ${safeStr(e.lastName)}</a>`
          : `<div>${safeStr(e.firstName)} ${safeStr(e.lastName)}</div>`;

        return `
          <div class="row${rankClass}">
            <div class="rank">${i + 1}</div>
            <div class="name">
              ${nameHtml}
              <div class="subtle"><span class="business-line-badge">${safeStr(e.businessLine || 'Unassigned')}</span></div>
            </div>
            <div class="metric ${valCls}">${display}</div>
            <div class="metric">${followerCount}</div>
            <div class="metric ${absoluteGrowthCls}">${absoluteGrowthStr}</div>
          </div>
        `;
      }).join('');

      board.innerHTML = html;
    }

    function renderBusinessLineBoard(metric, board) {
      // Update headers for business line view
      const container = document.getElementById('leaderboardContainer');
      if (container) {
        container.querySelector('.leaderboard-header').innerHTML = `
          <div>Rank</div>
          <div>Business Line</div>
          <div>Employees</div>
          <div id="metricHeader">${document.getElementById('metricHeader').textContent}</div>
          <div>Total Followers</div>
          <div>Avg per Employee</div>
        `;
      }

      let rows = [...BUSINESS_LINES];
      
      // Sort based on selected metric
      if (metric === 'monthlyGrowth') {
        rows = rows.sort((a, b) => (b.metrics?.monthlyGrowth || 0) - (a.metrics?.monthlyGrowth || 0));
      } else if (metric === 'monthlyGrowthRate') {
        rows = rows.sort((a, b) => (b.metrics?.monthlyGrowthRate || 0) - (a.metrics?.monthlyGrowthRate || 0));
      } else if (metric === 'currentFollowers') {
        rows = rows.sort((a, b) => (b.metrics?.currentFollowers || 0) - (a.metrics?.currentFollowers || 0));
      } else if (metric === 'overallGrowthRate') {
        rows = rows.sort((a, b) => (b.metrics?.growthRate || 0) - (a.metrics?.growthRate || 0));
      }

      if (!rows.length) {
        board.innerHTML = '<div class="no-data">No business line data available.</div>';
        return;
      }

      const html = rows.map((bl, i) => {
        const rankClass = i < 3 ? ` rank-${i + 1}` : '';
        
        let val, display;
        if (metric === 'monthlyGrowth') {
          val = bl.metrics?.monthlyGrowth || 0;
          display = fmtInt(val);
        } else if (metric === 'monthlyGrowthRate') {
          val = bl.metrics?.monthlyGrowthRate || 0;
          display = fmtPct(val);
        } else if (metric === 'currentFollowers') {
          val = bl.metrics?.currentFollowers || 0;
          display = fmtInt(val);
        } else if (metric === 'overallGrowthRate') {
          val = bl.metrics?.growthRate || 0;
          display = fmtPct(val);
        }
        
        const valCls = val > 0 ? 'pos' : (val < 0 ? 'neg' : 'neu');
        const totalFollowers = fmtInt(bl.metrics?.currentFollowers || 0);
        const avgPerEmployee = bl.employeeCount > 0 ? 
          fmtInt(Math.round((bl.metrics?.currentFollowers || 0) / bl.employeeCount)) : '0';

        return `
          <div class="row${rankClass}">
            <div class="rank">${i + 1}</div>
            <div class="name">
              <div>${safeStr(bl.name)}</div>
              <div class="subtle">${bl.employeeCount} employees</div>
            </div>
            <div class="metric">${bl.employeeCount}</div>
            <div class="metric ${valCls}">${display}</div>
            <div class="metric">${totalFollowers}</div>
            <div class="metric">${avgPerEmployee}</div>
          </div>
        `;
      }).join('');

      board.innerHTML = html;
    }

    function renderChart() {
      const ctx = document.getElementById('chart')?.getContext('2d');
      if (!ctx) return;

      const chartTitle = document.getElementById('chartTitle');
      if (chartTitle) {
        chartTitle.textContent = currentView === 'employee' ? 
          'Top 10 Employee Growth Trends' : 
          'Business Line Growth Trends';
      }

      if (chart) chart.destroy();

      let datasets = [];
      let labels = [];

      if (currentView === 'employee') {
        // Employee chart logic (existing)
        const top10 = getFilteredEmployees()
          .filter(e => typeof e.metrics?.growthRate === 'number')
          .sort((a, b) => b.metrics.growthRate - a.metrics.growthRate)
          .slice(0, 10);

        const allMonths = new Set();
        top10.forEach(e => {
          if (e.monthlyFollowers) {
            Object.keys(e.monthlyFollowers).forEach(monthKey => allMonths.add(monthKey));
          }
        });
        labels = Array.from(allMonths).sort().map(monthKey => {
          const monthData = top10.find(e => e.monthlyFollowers?.[monthKey]);
          return monthData?.monthlyFollowers?.[monthKey]?.displayName || monthKey;
        });

        datasets = top10.map((e, index) => {
          const colors = ['#22daae', '#ff4dd8', '#09100f', '#f9f8f5'];
          return {
            label: `${safeStr(e.firstName)} ${safeStr(e.lastName)}`.trim(),
            data: labels.map((_, labelIndex) => {
              const sortedMonths = Array.from(allMonths).sort();
              const monthKey = sortedMonths[labelIndex];
              return e.monthlyFollowers?.[monthKey]?.followers ?? null;
            }),
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            borderWidth: 3,
            spanGaps: true,
            tension: 0.3
          };
        });
      } else {
        // Business line chart logic
        const allMonths = new Set();
        BUSINESS_LINES.forEach(bl => {
          if (bl.monthlyFollowers) {
            Object.keys(bl.monthlyFollowers).forEach(monthKey => allMonths.add(monthKey));
          }
        });
        labels = Array.from(allMonths).sort().map(monthKey => {
          const monthData = BUSINESS_LINES.find(bl => bl.monthlyFollowers?.[monthKey]);
          return monthData?.monthlyFollowers?.[monthKey]?.displayName || monthKey;
        });

        datasets = BUSINESS_LINES.map((bl, index) => {
          const colors = ['#22daae', '#ff4dd8', '#09100f', '#f9f8f5'];
          return {
            label: bl.name,
            data: labels.map((_, labelIndex) => {
              const sortedMonths = Array.from(allMonths).sort();
              const monthKey = sortedMonths[labelIndex];
              return bl.monthlyFollowers?.[monthKey]?.followers ?? null;
            }),
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            borderWidth: 3,
            spanGaps: true,
            tension: 0.3
          };
        });
      }

      if (!labels.length || !datasets.length) return;

      chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { 
              display: true, 
              text: currentView === 'employee' ? 
                'LinkedIn Follower Growth Trends' : 
                'Business Line Growth Trends',
              font: {
                family: 'Inter',
                size: 16,
                weight: '600'
              },
              color: '#09100f'
            },
            legend: { 
              display: true, 
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 20,
                font: {
                  family: 'Inter',
                  size: 12,
                  weight: '500'
                },
                color: '#09100f'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(9, 16, 15, 0.9)',
              titleColor: '#f9f8f5',
              bodyColor: '#f9f8f5',
              borderColor: '#22daae',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: true,
              titleFont: {
                family: 'Inter',
                size: 13,
                weight: '600'
              },
              bodyFont: {
                family: 'Inter',
                size: 12
              }
            }
          },
          scales: {
            y: { 
              beginAtZero: false, 
              title: { 
                display: true, 
                text: 'Followers',
                font: {
                  family: 'Inter',
                  size: 12,
                  weight: '500'
                },
                color: '#09100f'
              },
              grid: {
                color: 'rgba(9, 16, 15, 0.1)'
              },
              ticks: {
                font: {
                  family: 'Inter',
                  size: 11
                },
                color: 'rgba(9, 16, 15, 0.7)'
              }
            },
            x: { 
              title: { 
                display: true, 
                text: 'Month',
                font: {
                  family: 'Inter',
                  size: 12,
                  weight: '500'
                },
                color: '#09100f'
              },
              grid: {
                color: 'rgba(9, 16, 15, 0.1)'
              },
              ticks: {
                font: {
                  family: 'Inter',
                  size: 11
                },
                color: 'rgba(9, 16, 15, 0.7)'
              }
            }
          }
        }
      });
    }

    // ---------- Events ----------
    document.addEventListener('DOMContentLoaded', () => {
      const metricSelect = document.getElementById('metric');
      const teamSelect = document.getElementById('team');
      const chartMonthSelect = document.getElementById('chartMonth');
      const refreshBtn = document.getElementById('refresh');
      const periodSelect = document.getElementById('periodSelect');

      if (metricSelect) metricSelect.addEventListener('change', () => {
        renderBoard(); 
        renderChart();
      });
      
      if (teamSelect) teamSelect.addEventListener('change', () => {
        renderBoard(); 
        renderChart();
      });

      if (chartMonthSelect) chartMonthSelect.addEventListener('change', () => {
        renderChart();
      });
      
      if (refreshBtn) refreshBtn.addEventListener('click', fetchData);

      if (periodSelect) periodSelect.addEventListener('change', (e) => {
        const selectedMonth = e.target.value;
        const winners = currentView === 'employee' ? MONTHLY_WINNERS : 
          (MONTHLY_WINNERS.businessLines || []);
        const winnerData = winners.find(w => w.monthKey === selectedMonth);
        if (winnerData) {
          showMonthlyWinner(winnerData);
        }
      });

      // Initialize
      fetchData();
      setInterval(fetchData, 5 * 60 * 1000);
    });
  </script>
</body>
</html>
