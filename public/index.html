<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>LinkedIn Growth Leaderboard</title>
  <meta name="description" content="Track LinkedIn growth across teams with an interactive leaderboard and trend chart." />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg1: #667eea;
      --bg2: #764ba2;
      --white: #fff;
      --ink: #333;
      --muted: #6b7280;
      --brand: #667eea;
      --good: #10b981;
      --bad: #ef4444;
      --card: #ffffff;
      --shadow: 0 10px 30px rgba(0,0,0,.12);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      min-height: 100vh;
      color: var(--ink);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .header {
      color: var(--white);
      padding: 20px;
      margin-bottom: 24px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.1);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
    }
    .header h1 { font-size: 28px; margin-bottom: 6px; }
    .header p { opacity: .9; }
    .last-updated { font-size: 13px; opacity: .85; margin-top: 8px; }

    .controls {
      display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap: 12px; margin-bottom: 20px;
    }
    .control {
      display: grid; gap: 6px; align-items: center; color: var(--white);
    }
    label { font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,.25); }
    select, button {
      width: 100%;
      appearance: none;
      border: none; border-radius: 999px;
      padding: 10px 14px; font-weight: 600; font-size: 14px;
      box-shadow: 0 5px 18px rgba(0,0,0,.2);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    select { background: var(--white); color: var(--ink); }
    button { background: #ff6b6b; color: #fff; cursor: pointer; }
    select:hover, button:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,.28); }
    button:disabled { opacity: .6; cursor: not-allowed; transform: none; }

    .error {
      display: none; background: var(--bad); color: #fff;
      padding: 12px 14px; border-radius: 10px; margin-bottom: 16px; text-align: center;
      box-shadow: var(--shadow);
    }
    .loading { color: var(--white); text-align: center; padding: 40px; font-size: 16px; }

    .stats {
      display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap: 14px; margin-bottom: 20px;
    }
    .stat {
      background: var(--card); padding: 18px; border-radius: 14px;
      text-align: center; box-shadow: var(--shadow);
    }
    .stat .num { font-size: 24px; font-weight: 800; color: var(--brand); }
    .stat .lbl { color: var(--muted); font-size: 13px; }

    /* Monthly Winner Styles */
    .monthly-winner {
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: white;
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    .monthly-winner h3 {
      margin-bottom: 12px;
      font-size: 18px;
    }
    .winner-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .winner-details {
      flex: 1;
    }
    .winner-name {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 4px;
    }
    .winner-name a {
      color: inherit;
      text-decoration: none;
    }
    .winner-name a:hover {
      text-decoration: underline;
    }
    .winner-growth {
      font-size: 24px;
      font-weight: 900;
      color: #10b981;
    }
    .period-selector {
      margin-bottom: 16px;
    }
    .period-selector label {
      margin-right: 8px;
      font-weight: 600;
    }
    .period-selector select {
      background: rgba(255,255,255,0.9);
      color: #333;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      min-width: 200px;
    }

    .panel {
      background: var(--card); border-radius: 16px; padding: 20px; box-shadow: var(--shadow);
      margin-bottom: 20px;
    }
    .panel h2 { font-size: 20px; margin-bottom: 14px; }

    .leaderboard-header, .row {
      display: grid; align-items: center; gap: 16px;
      grid-template-columns: 56px 1fr 120px 120px 120px;
      padding: 12px 14px;
    }
    .leaderboard-header {
      color: var(--muted); font-weight: 700; border-bottom: 2px solid #f2f3f9;
      margin-bottom: 6px;
    }
    .row {
      border-radius: 12px; transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
      border-left: 4px solid transparent; margin-bottom: 8px;
    }
    .row:hover { background: #f7f8ff; transform: translateX(4px); box-shadow: 0 4px 16px rgba(0,0,0,.08); }
    .row.rank-1 { background: linear-gradient(45deg,#ffd700,#ffec80); border-left-color:#ffd700; }
    .row.rank-2 { background: linear-gradient(45deg,#c0c0c0,#e2e8f0); border-left-color:#c0c0c0; }
    .row.rank-3 { background: linear-gradient(45deg,#cd7f32,#d9a15b); border-left-color:#cd7f32; }

    .rank {
      width: 40px; height: 40px; border-radius: 999px; background: #eef2ff;
      color: var(--brand); display:flex; align-items:center; justify-content:center;
      font-weight: 800; font-size: 18px;
    }
    .row.rank-1 .rank, .row.rank-2 .rank, .row.rank-3 .rank { color: #fff; background: rgba(0,0,0,.15); }

    .name a, .name div { font-weight: 700; color: #222; text-decoration: none; }
    .name a:hover { color: var(--brand); text-decoration: underline; }
    .subtle { color: var(--muted); font-size: 13px; margin-top: 2px; }

    .metric { text-align: center; font-weight: 800; }
    .pos { color: var(--good); }
    .neg { color: var(--bad); }
    .neu { color: #6b7280; }

    .no-data { color:#6b7280; font-style: italic; text-align:center; padding: 28px; }

    @media (max-width: 760px) {
      .leaderboard-header, .row { grid-template-columns: 50px 1fr 110px; }
      .leaderboard-header > :nth-child(n+4), .row > :nth-child(n+4) { display: none; }
      .winner-info { flex-direction: column; text-align: center; }
      .period-selector { text-align: center; }
      .period-selector select { min-width: auto; width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>LinkedIn Growth Leaderboard</h1>
      <p>Track follower growth, compare teams, and spot top performers.</p>
      <div class="last-updated" id="lastUpdated"></div>
    </header>

    <div id="error" class="error"></div>

    <section class="controls">
      <div class="control">
        <label for="metric">Sort by</label>
        <select id="metric">
          <option value="monthlyGrowth">Monthly Growth (Followers)</option>
          <option value="monthlyGrowthRate">Monthly Growth %</option>
          <option value="currentFollowers">Follower Count</option>
          <option value="overallGrowthRate">Overall Growth %</option>
        </select>
      </div>
      <div class="control">
        <label for="team">Business Line</label>
        <select id="team">
          <option value="all">All Teams</option>
        </select>
      </div>
      <div class="control">
        <label>&nbsp;</label>
        <button id="refresh">Refresh Data</button>
      </div>
    </section>

    <div id="loading" class="loading">Loading leaderboard data…</div>

    <main id="main" style="display:none">
      <section class="stats">
        <article class="stat">
          <div class="num" id="statTotal">-</div>
          <div class="lbl">Active Employees</div>
        </article>
        <article class="stat">
          <div class="num" id="statAvgGrowth">-</div>
          <div class="lbl">Avg Growth Rate</div>
        </article>
        <article class="stat">
          <div class="num" id="statTopGrower">-</div>
          <div class="lbl">Top Grower</div>
        </article>
        <article class="stat">
          <div class="num" id="statTotalFollowers">-</div>
          <div class="lbl">Total Network</div>
        </article>
      </section>

      <section class="monthly-winner" id="monthlyWinnerSection" style="display:none">
        <div class="period-selector">
          <label for="periodSelect">Monthly Winners:</label>
          <select id="periodSelect">
            <option value="">Select a month...</option>
          </select>
        </div>
        <div id="monthlyWinnerContent">
          <h3>Monthly Champion</h3>
          <div class="winner-info">
            <div class="winner-details">
              <div class="winner-name" id="winnerName">—</div>
              <div class="subtle" id="winnerTeam">—</div>
            </div>
            <div class="winner-growth" id="winnerGrowth">—</div>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="leaderboard-header">
          <div>Rank</div>
          <div>Employee</div>
          <div id="metricHeader">Monthly Growth</div>
          <div>Follower Count</div>
          <div>Absolute Growth</div>
      </div>
        <div id="board"></div>
      </section>

      <section class="panel">
        <h2>Top 10 Growth Trends</h2>
        <canvas id="chart" width="400" height="220" aria-label="Top 10 growth trend lines" role="img"></canvas>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = '/api';
    let EMPLOYEES = [];
    let MONTHLY_WINNERS = [];
    let SUMMARY = {};
    let chart;

    // ---------- Utilities ----------
    const fmtPct = (n) => `${Number(n || 0).toFixed(1)}%`;
    const fmtInt = (n) => Number(n || 0).toLocaleString();
    const safeStr = (s) => (s == null ? '' : String(s));

    function setLoading(on) {
      document.getElementById('loading').style.display = on ? 'block' : 'none';
      document.getElementById('main').style.display = on ? 'none' : 'block';
      document.getElementById('refresh').disabled = on;
    }

    function showError(msg) {
      const box = document.getElementById('error');
      box.textContent = msg;
      box.style.display = 'block';
    }
    function hideError() {
      document.getElementById('error').style.display = 'none';
    }

    // ---------- Data fetch + normalization ----------
    async function fetchData() {
      setLoading(true);
      hideError();
      try {
        const res = await fetch(`${API_BASE}/employees`, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error(`HTTP ${res.status} – ${res.statusText}`);
        const data = await res.json();

        EMPLOYEES = Array.isArray(data.employees) ? data.employees : [];
        MONTHLY_WINNERS = Array.isArray(data.monthlyWinners) ? data.monthlyWinners : [];
        SUMMARY = data.summary || {};

        renderAll();
      } catch (err) {
        console.error(err);
        showError(`Failed to load data: ${err.message}`);
      } finally {
        setLoading(false);
      }
    }

    // ---------- Rendering ----------
    function renderAll() {
      populateTeamFilter();
      populatePeriodSelector();
      renderStats();
      renderBoard();
      renderChart();
      renderLastUpdated();
    }

    function renderLastUpdated() {
      const el = document.getElementById('lastUpdated');
      const ts = SUMMARY.lastUpdated ? new Date(SUMMARY.lastUpdated) : null;
      el.textContent = ts ? `Last updated: ${ts.toLocaleString()}` : '';
    }

    function renderStats() {
      document.getElementById('statTotal').textContent = fmtInt(SUMMARY.totalEmployees || EMPLOYEES.length || 0);
      document.getElementById('statAvgGrowth').textContent = fmtPct(SUMMARY.avgGrowthRate || 0);
      document.getElementById('statTopGrower').textContent = safeStr(SUMMARY.topGrower || '—');
      document.getElementById('statTotalFollowers').textContent = fmtInt(SUMMARY.totalFollowers || 0);
    }

    function populateTeamFilter() {
      const sel = document.getElementById('team');
      while (sel.children.length > 1) sel.removeChild(sel.lastChild);

      const lines = [...new Set(EMPLOYEES.map(e => e.businessLine).filter(Boolean))].sort();
      lines.forEach(line => {
        const opt = document.createElement('option');
        opt.value = line.toLowerCase();
        opt.textContent = line;
        sel.appendChild(opt);
      });
    }

    function populatePeriodSelector() {
      const select = document.getElementById('periodSelect');
      select.innerHTML = '<option value="">Select a month...</option>';
      
      MONTHLY_WINNERS.forEach((winner, index) => {
        const option = document.createElement('option');
        option.value = winner.monthKey;
        option.textContent = winner.month;
        if (index === 0) option.selected = true;
        select.appendChild(option);
      });
      
      const section = document.getElementById('monthlyWinnerSection');
      section.style.display = MONTHLY_WINNERS.length > 0 ? 'block' : 'none';
      
      if (MONTHLY_WINNERS.length > 0) {
        showMonthlyWinner(MONTHLY_WINNERS[0]);
      }
    }

    function showMonthlyWinner(winnerData) {
      const nameEl = document.getElementById('winnerName');
      const teamEl = document.getElementById('winnerTeam');
      const growthEl = document.getElementById('winnerGrowth');
      
      if (winnerData.winner.linkedinProfile) {
        nameEl.innerHTML = `<a href="${winnerData.winner.linkedinProfile}" target="_blank" rel="noopener noreferrer">${winnerData.winner.name}</a>`;
      } else {
        nameEl.textContent = winnerData.winner.name;
      }
      
      teamEl.textContent = winnerData.winner.businessLine || 'Unassigned';
      growthEl.textContent = `+${fmtInt(winnerData.winner.monthlyGrowth)}`;
    }

    function getFilteredEmployees() {
      const teamVal = document.getElementById('team').value;
      const list = (teamVal === 'all')
        ? EMPLOYEES
        : EMPLOYEES.filter(e => (e.businessLine || '').toLowerCase().includes(teamVal));
      return [...list];
    }

    function getLatestMonthlyMetric(employee) {
      if (!employee.monthlyMetrics || employee.monthlyMetrics.length === 0) {
        return {
          currentFollowers: employee.metrics?.currentFollowers || 0,
          monthlyGrowth: 0,
          monthlyGrowthRate: 0
        };
      }
      const latest = employee.monthlyMetrics[employee.monthlyMetrics.length - 1];
      return {
        currentFollowers: latest.currentFollowers,
        monthlyGrowth: latest.monthlyGrowth,
        monthlyGrowthRate: latest.monthlyGrowthRate
      };
    }

    function renderBoard() {
      const metric = document.getElementById('metric').value;
      const board = document.getElementById('board');
      const headerMap = {
        monthlyGrowth: { title: 'Monthly Growth Leaderboard', header: 'Monthly Growth' },
        monthlyGrowthRate: { title: 'Monthly Growth % Leaderboard', header: 'Growth %' },
        currentFollowers: { title: 'Follower Count Leaderboard', header: 'Followers' },
        overallGrowthRate: { title: 'Overall Growth % Leaderboard', header: 'Overall Growth %' }
      };
      
      document.getElementById('boardTitle').textContent = headerMap[metric].title;
      document.getElementById('metricHeader').textContent = headerMap[metric].header;

      let rows = getFilteredEmployees();
      
      // Sort based on selected metric
      if (metric === 'monthlyGrowth') {
        rows = rows.sort((a, b) => {
          const aMetric = getLatestMonthlyMetric(a);
          const bMetric = getLatestMonthlyMetric(b);
          return bMetric.monthlyGrowth - aMetric.monthlyGrowth;
        });
      } else if (metric === 'monthlyGrowthRate') {
        rows = rows.sort((a, b) => {
          const aMetric = getLatestMonthlyMetric(a);
          const bMetric = getLatestMonthlyMetric(b);
          return bMetric.monthlyGrowthRate - aMetric.monthlyGrowthRate;
        });
      } else if (metric === 'currentFollowers') {
        rows = rows.sort((a, b) => {
          const aMetric = getLatestMonthlyMetric(a);
          const bMetric = getLatestMonthlyMetric(b);
          return bMetric.currentFollowers - aMetric.currentFollowers;
        });
      } else if (metric === 'overallGrowthRate') {
        rows = rows.sort((a, b) => (b.metrics?.growthRate ?? 0) - (a.metrics?.growthRate ?? 0));
      }

      if (!rows.length) {
        board.innerHTML = '<div class="no-data">No data available for selected filters.</div>';
        return;
      }

      const html = rows.map((e, i) => {
  const rankClass = i < 3 ? ` rank-${i + 1}` : '';
  const monthlyMetric = getLatestMonthlyMetric(e);
  
  let val, display;
  if (metric === 'monthlyGrowth') {
    val = monthlyMetric.monthlyGrowth;
    display = fmtInt(val);
  } else if (metric === 'monthlyGrowthRate') {
    val = monthlyMetric.monthlyGrowthRate;
    display = fmtPct(val);
  } else if (metric === 'currentFollowers') {
    val = monthlyMetric.currentFollowers;
    display = fmtInt(val);
  } else if (metric === 'overallGrowthRate') {
    val = e.metrics?.growthRate ?? 0;
    display = fmtPct(val);
  }
  
  const valCls = val > 0 ? 'pos' : (val < 0 ? 'neg' : 'neu');
  
  const followerCount = fmtInt(monthlyMetric.currentFollowers);
  const absoluteGrowth = monthlyMetric.monthlyGrowth;
  const absoluteGrowthCls = absoluteGrowth >= 0 ? 'pos' : 'neg';
  const absoluteGrowthStr = absoluteGrowth >= 0 ? `+${fmtInt(absoluteGrowth)}` : fmtInt(absoluteGrowth);

  const nameHtml = e.linkedinProfile
    ? `<a href="${e.linkedinProfile}" target="_blank" rel="noopener noreferrer">${safeStr(e.firstName)} ${safeStr(e.lastName)}</a>`
    : `<div>${safeStr(e.firstName)} ${safeStr(e.lastName)}</div>`;

  return `
    <div class="row${rankClass}">
      <div class="rank">${i + 1}</div>
      <div class="name">
        ${nameHtml}
        <div class="subtle">${safeStr(e.businessLine || 'Unassigned')}</div>
      </div>
      <div class="metric ${valCls}">${display}</div>
      <div class="metric">${followerCount}</div>
      <div class="metric ${absoluteGrowthCls}">${absoluteGrowthStr}</div>
    </div>
  `;
}).join('');

      board.innerHTML = html;
    }

    function renderChart() {
      const ctx = document.getElementById('chart').getContext('2d');

      // Get top 10 by overall growth rate for chart
      const top10 = getFilteredEmployees()
        .filter(e => typeof e.metrics?.growthRate === 'number')
        .sort((a, b) => b.metrics.growthRate - a.metrics.growthRate)
        .slice(0, 10);

      const allMonths = new Set();
      top10.forEach(e => {
        if (e.monthlyFollowers) {
          Object.keys(e.monthlyFollowers).forEach(monthKey => allMonths.add(monthKey));
        }
      });
      const sortedMonths = Array.from(allMonths).sort();

      const datasets = top10.map(e => ({
        label: `${safeStr(e.firstName)} ${safeStr(e.lastName)}`.trim(),
        data: sortedMonths.map(monthKey => {
          return e.monthlyFollowers?.[monthKey]?.followers ?? null;
        }),
        spanGaps: true,
        tension: 0.3
      }));

      if (chart) chart.destroy();
      if (!sortedMonths.length || !datasets.length) return;

      chart = new Chart(ctx, {
        type: 'line',
        data: { 
          labels: sortedMonths.map(monthKey => {
            const monthData = top10.find(e => e.monthlyFollowers?.[monthKey]);
            return monthData?.monthlyFollowers?.[monthKey]?.displayName || monthKey;
          }), 
          datasets 
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: 'LinkedIn Follower Growth Trends' },
            legend: { display: true, position: 'bottom' }
          },
          scales: {
            y: { beginAtZero: false, title: { display: true, text: 'Followers' } },
            x: { title: { display: true, text: 'Month' } }
          }
        }
      });
    }

    // ---------- Events ----------
    document.getElementById('metric').addEventListener('change', () => {
      renderBoard(); renderChart();
    });
    document.getElementById('team').addEventListener('change', () => {
      renderBoard(); renderChart();
    });
    document.getElementById('refresh').addEventListener('click', fetchData);

    document.getElementById('periodSelect').addEventListener('change', (e) => {
      const selectedMonth = e.target.value;
      const winnerData = MONTHLY_WINNERS.find(w => w.monthKey === selectedMonth);
      if (winnerData) {
        showMonthlyWinner(winnerData);
      }
    });

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', () => {
      fetchData();
      setInterval(fetchData, 5 * 60 * 1000);
    });
  </script>
</body>
</html>
